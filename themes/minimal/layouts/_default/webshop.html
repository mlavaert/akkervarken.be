{{ define "main" }}
{{ .Content }}

<div class="batches">
        {{ range $index, $batch := .Site.Data.batches.batches }}
        <div class="batch {{ if eq $index 0 }}open{{ else }}closed{{ end }}">
            <div class="batch-header" onclick="toggleBatch(this)">
                <h3>{{ .name }}</h3>
                <span class="toggle-icon">{{ if eq $index 0 }}−{{ else }}+{{ end }}</span>
            </div>
            <div class="batch-content">
                <div class="batch-info">
                    <p><strong>Slachtdatum:</strong> {{ index . "slaughter-date" }}</p>
                    <p><strong>Bestellen tot:</strong> {{ index . "order-deadline" }}</p>
                    <p><strong>Ophalen tussen:</strong> {{ index . "pickup-date-start" }} en {{ index . "pickup-date-end" }}</p>
                    <p><strong>Ophaallocatie:</strong> {{ index . "pickup-location" }}</p>
                </div>
                
                <div class="products">
                    {{ range index . "available-products" }}
                    {{ $productId := index . "product-id" }}
                    {{ $stock := .stock }}
                    {{ $batchId := $batch.id }}
                    {{ range $.Site.Data.products.products }}
                    {{ if eq .id $productId }}
                    <div class="product" data-id="{{ $batchId }}-{{ .id }}" data-name="{{ .name }}" data-price="{{ .price }}" data-weight="{{ .weight }}" data-pickup-start="{{ index $batch "pickup-date-start" }}" data-pickup-end="{{ index $batch "pickup-date-end" }}" data-batch="{{ $batch.name }}">
                        {{ if .image }}
                        <div class="product-image">
                            <img src="{{ .image | relURL }}" alt="{{ .name }}" loading="lazy">
                        </div>
                        {{ end }}
                        <h4>{{ .name }}</h4>
                        <p class="description">{{ .description }}</p>
                        <div class="product-details">
                            <span class="price">{{ .price }}</span>
                            <span class="weight">{{ .weight }}</span>
                        </div>
                        <div class="stock">
                            <small>Nog {{ $stock }} beschikbaar</small>
                        </div>
                        <div class="quantity-controls">
                            <button type="button" onclick="decreaseQuantity('{{ $batchId }}-{{ .id }}')">-</button>
                            <input type="number" id="qty-{{ $batchId }}-{{ .id }}" value="0" min="0" max="{{ $stock }}" onchange="updateQuantity('{{ $batchId }}-{{ .id }}', this.value)">
                            <button type="button" onclick="increaseQuantity('{{ $batchId }}-{{ .id }}')">+</button>
                        </div>
                    </div>
                    {{ end }}
                    {{ end }}
                    {{ end }}
                </div>
            </div>
        </div>
        {{ end }}
    </div>
    
    <section class="order-summary">
        <h3>Bestelling</h3>
        <div id="order-items"></div>
        <div id="order-total"></div>
        <button id="send-order" onclick="sendOrder()" style="display: none;">Bestelling versturen via e-mail</button>
    </section>

<script>
let cart = {};
let currentBatch = null; // Track which batch is currently selected

function toggleBatch(header) {
    const batch = header.parentElement;
    const content = batch.querySelector('.batch-content');
    const icon = header.querySelector('.toggle-icon');
    const allBatches = document.querySelectorAll('.batch');
    
    // If this batch is already open, don't close it (keep at least one open)
    if (batch.classList.contains('open')) {
        return;
    }
    
    // Close all other batches
    allBatches.forEach(otherBatch => {
        if (otherBatch !== batch) {
            otherBatch.classList.remove('open');
            otherBatch.classList.add('closed');
            const otherIcon = otherBatch.querySelector('.toggle-icon');
            otherIcon.textContent = '+';
        }
    });
    
    // Open this batch
    batch.classList.remove('closed');
    batch.classList.add('open');
    icon.textContent = '−';
}

function updateQuantity(productId, quantity) {
    quantity = parseInt(quantity) || 0;
    
    if (quantity <= 0) {
        delete cart[productId];
        // If cart is empty, reset current batch
        if (Object.keys(cart).length === 0) {
            currentBatch = null;
            enableAllBatches();
        }
    } else {
        const product = document.querySelector(`[data-id="${productId}"]`);
        const productBatch = product.dataset.batch;
        
        // Check if this is from a different batch
        if (currentBatch && currentBatch !== productBatch) {
            alert(`Je kunt alleen producten uit één batch bestellen.\n\nJe hebt al producten uit "${currentBatch}" geselecteerd.\n\nWil je vlees uit meerdere batches? Plaats dan afzonderlijke bestellingen.`);
            // Reset the input to 0
            document.getElementById(`qty-${productId}`).value = 0;
            return;
        }
        
        // Set current batch if this is the first item
        if (!currentBatch) {
            currentBatch = productBatch;
            disableOtherBatches(productBatch);
        }
        
        cart[productId] = {
            name: product.dataset.name,
            price: product.dataset.price,
            weight: product.dataset.weight,
            pickupStart: product.dataset.pickupStart,
            pickupEnd: product.dataset.pickupEnd,
            batch: product.dataset.batch,
            quantity: quantity
        };
    }
    updateOrderSummary();
}

function disableOtherBatches(selectedBatch) {
    const allBatches = document.querySelectorAll('.batch');
    allBatches.forEach(batch => {
        // Check if any product in this batch matches the selected batch
        const productsInBatch = batch.querySelectorAll('.product');
        let isSameBatch = false;
        
        productsInBatch.forEach(product => {
            if (product.dataset.batch === selectedBatch) {
                isSameBatch = true;
            }
        });
        
        if (!isSameBatch) {
            batch.classList.add('disabled');
            // Disable all inputs in this batch
            const inputs = batch.querySelectorAll('input, button');
            inputs.forEach(input => {
                input.disabled = true;
            });
        }
    });
}

function enableAllBatches() {
    const allBatches = document.querySelectorAll('.batch');
    allBatches.forEach(batch => {
        batch.classList.remove('disabled');
        // Enable all inputs in this batch
        const inputs = batch.querySelectorAll('input, button');
        inputs.forEach(input => {
            input.disabled = false;
        });
    });
}

function increaseQuantity(productId) {
    const input = document.getElementById(`qty-${productId}`);
    const max = parseInt(input.max);
    const current = parseInt(input.value) || 0;
    if (current < max) {
        input.value = current + 1;
        updateQuantity(productId, input.value);
    }
}

function decreaseQuantity(productId) {
    const input = document.getElementById(`qty-${productId}`);
    const current = parseInt(input.value) || 0;
    if (current > 0) {
        input.value = current - 1;
        updateQuantity(productId, input.value);
    }
}

function updateOrderSummary() {
    const orderItems = document.getElementById('order-items');
    const orderTotal = document.getElementById('order-total');
    const sendButton = document.getElementById('send-order');
    
    if (Object.keys(cart).length === 0) {
        orderItems.innerHTML = '<p>Geen items geselecteerd</p>';
        orderTotal.innerHTML = '';
        sendButton.style.display = 'none';
        return;
    }
    
    // Since we only allow one batch, this is simplified
    let html = `<div class="order-batch"><strong>${currentBatch}</strong><ul>`;
    let totalItems = 0;
    
    for (const [productId, item] of Object.entries(cart)) {
        html += `<li>${item.quantity}x ${item.name} (${item.weight} per stuk) - Ophalen: ${item.pickupStart} tot ${item.pickupEnd}</li>`;
        totalItems += item.quantity;
    }
    html += '</ul></div>';
    
    orderItems.innerHTML = html;
    orderTotal.innerHTML = `<strong>Totaal: ${totalItems} pakket(ten)</strong>`;
    sendButton.style.display = 'block';
}

function sendOrder() {
    if (Object.keys(cart).length === 0) {
        alert('Selecteer eerst producten om te bestellen.');
        return;
    }
    
    let emailBody = 'Beste Akkervarken.be,%0D%0A%0D%0A';
    emailBody += 'Hierbij mijn bestelling:%0D%0A%0D%0A';
    
    let totalItems = 0;
    let pickupDate = '';
    
    // Get batch name and pickup dates from first item
    const firstItem = Object.values(cart)[0];
    const batchName = firstItem.batch;
    const pickupStart = firstItem.pickupStart;
    const pickupEnd = firstItem.pickupEnd;
    
    emailBody += `Batch: ${batchName}%0D%0A`;
    emailBody += `Ophalen tussen: ${pickupStart} en ${pickupEnd}%0D%0A%0D%0A`;
    emailBody += 'Producten:%0D%0A';
    
    for (const [productId, item] of Object.entries(cart)) {
        emailBody += `- ${item.quantity}x ${item.name} (${item.weight} per stuk)%0D%0A`;
        totalItems += item.quantity;
    }
    
    emailBody += `%0D%0ATotaal: ${totalItems} pakket(ten)%0D%0A%0D%0A`;
    emailBody += 'Graag bevestiging van deze bestelling.%0D%0A%0D%0A';
    emailBody += 'Met vriendelijke groeten,%0D%0A';
    emailBody += '[Vul hier je naam in]';
    
    const subject = `Bestelling Akkervarken.be - ${batchName}`;
    const mailtoLink = `mailto:info@akkervarken.be?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
    
    window.location.href = mailtoLink;
}
</script>
{{ end }}